# MusicForge AI - Development Context

> Quick reference for developers working on this project

---

## Project Information

- **Project Root**: `/Users/ahmedmustafa/Desktop/MPA ag/MusicForge`
- **Repository**: Local (Git to be initialized)
- **Last Updated**: 2026-01-13
- **Primary Languages**: C# (.NET 9), Python (3.11+)

---

## Tech Stack

| Component | Technology | Version | Documentation |
|-----------|-----------|---------|---------------|
| **C# Orchestration** | | | |
| Framework | .NET 9 | 9.0 | [Docs](https://learn.microsoft.com/dotnet) |
| API | ASP.NET Core Minimal API | 9.0 | [Docs](https://learn.microsoft.com/aspnet/core/fundamentals/minimal-apis) |
| Real-time | SignalR | 9.0 | [Docs](https://learn.microsoft.com/aspnet/core/signalr) |
| ORM | EF Core | 9.0 | [Docs](https://learn.microsoft.com/ef/core) |
| Database | SQLite | 3.x | [Docs](https://www.sqlite.org/docs.html) |
| CQRS | MediatR | 12.x | [GitHub](https://github.com/jbogard/MediatR) |
| Validation | FluentValidation | 11.x | [Docs](https://docs.fluentvalidation.net) |
| gRPC | Grpc.Net.Client | 2.x | [Docs](https://grpc.io/docs/languages/csharp) |
| CLI | System.CommandLine | 2.x | [GitHub](https://github.com/dotnet/command-line-api) |
| **Python Workers** | | | |
| Runtime | Python | 3.11+ | [Docs](https://docs.python.org/3.11) |
| gRPC | grpcio | 1.60+ | [Docs](https://grpc.io/docs/languages/python) |
| AI/ML | PyTorch | 2.1+ | [Docs](https://pytorch.org/docs) |
| Audio Gen | AudioCraft | 1.3+ | [GitHub](https://github.com/facebookresearch/audiocraft) |
| Vocals | Bark | 0.1+ | [GitHub](https://github.com/suno-ai/bark) |
| Theory | music21 | 9.1+ | [Docs](https://web.mit.edu/music21/doc) |
| MIDI | pretty_midi | 0.2+ | [GitHub](https://github.com/craffel/pretty-midi) |
| Audio FX | Pedalboard | 0.9+ | [GitHub](https://github.com/spotify/pedalboard) |
| Stems | Demucs | 4.0+ | [GitHub](https://github.com/facebookresearch/demucs) |
| **DevOps** | | | |
| Containers | Docker | 24+ | [Docs](https://docs.docker.com) |
| Orchestration | Docker Compose | 2.x | [Docs](https://docs.docker.com/compose) |

---

## Directory Structure

```
MusicForge/
├── ARCHITECTURE.md              # System design and decisions
├── .context.md                  # This file
├── backlog.csv                  # Task tracking
├── README.md                    # User-facing documentation
├── MusicForge.sln              # .NET Solution file
├── src/
│   ├── MusicForge.Domain/       # Core domain (entities, value objects)
│   │   ├── Entities/
│   │   ├── ValueObjects/
│   │   ├── Enums/
│   │   ├── Events/
│   │   └── Abstractions/
│   ├── MusicForge.Application/  # Use cases, services, interfaces
│   │   ├── Commands/
│   │   ├── Queries/
│   │   ├── Services/
│   │   ├── Interfaces/
│   │   └── DTOs/
│   ├── MusicForge.Infrastructure/ # External concerns
│   │   ├── Grpc/
│   │   ├── Llm/
│   │   ├── Persistence/
│   │   └── FileStorage/
│   ├── MusicForge.Api/          # HTTP API + SignalR
│   │   ├── Endpoints/
│   │   ├── Hubs/
│   │   └── Middleware/
│   └── MusicForge.Cli/          # Command-line interface
│       └── Commands/
├── workers/
│   └── python/                  # Python AI workers
│       ├── src/
│       │   ├── components/      # Theory, Audio, Vocals, Stems
│       │   ├── domain/          # Python data models
│       │   ├── grpc_generated/  # Generated protobuf code
│       │   ├── server.py
│       │   └── config.py
│       ├── tests/
│       ├── pyproject.toml
│       ├── requirements.txt
│       └── Dockerfile
├── protos/
│   └── worker.proto             # gRPC service definition
├── tests/
│   ├── MusicForge.Domain.Tests/
│   ├── MusicForge.Application.Tests/
│   └── MusicForge.Integration.Tests/
├── docker-compose.yml
└── .gitignore
```

---

## Development Setup

### Prerequisites

- .NET 9 SDK
- Python 3.11+
- Docker & Docker Compose
- NVIDIA GPU (recommended) with CUDA 12.x
- 16GB+ RAM (for model loading)

### First-Time Setup

```bash
# Clone/navigate to project
cd /Users/ahmedmustafa/Desktop/MPA\ ag/MusicForge

# Build .NET solution
dotnet restore
dotnet build

# Setup Python environment
cd workers/python
python -m venv .venv
source .venv/bin/activate  # or .venv\Scripts\activate on Windows
pip install -r requirements.txt

# Run with Docker
docker-compose up -d
```

### Available Commands

| Command | Description |
|---------|-------------|
| `dotnet run --project src/MusicForge.Api` | Start API server |
| `dotnet run --project src/MusicForge.Cli` | Run CLI |
| `dotnet test` | Run all tests |
| `cd workers/python && python src/server.py` | Start Python worker |
| `docker-compose up` | Start all services |

---

## Coding Standards

### C# Conventions

#### Naming

| Element | Convention | Example |
|---------|-----------|---------|
| Classes | PascalCase | `ProjectService`, `AudioSynthesizer` |
| Interfaces | IPascalCase | `IProjectRepository`, `IMusicWorkerClient` |
| Methods | PascalCase | `GenerateAsync`, `ParseIntent` |
| Properties | PascalCase | `ProjectId`, `IsComplete` |
| Private fields | _camelCase | `_repository`, `_logger` |
| Local variables | camelCase | `projectId`, `stemCount` |
| Constants | PascalCase | `MaxRetries`, `DefaultTempo` |
| Async methods | Suffix with Async | `GetByIdAsync`, `GenerateAsync` |

#### File Organization

```csharp
// 1. Usings (sorted, no unused)
using System;
using MediatR;
using MusicForge.Domain.Entities;

// 2. Namespace (file-scoped)
namespace MusicForge.Application.Commands;

// 3. Type (one per file, matches filename)
public sealed record CreateProjectCommand(
    string Name,
    string Description,
    Genre Genre
) : IRequest<ProjectId>;
```

#### Best Practices

```csharp
// ✅ Use records for DTOs and commands
public sealed record CreateProjectCommand(string Name, Genre Genre) : IRequest<ProjectId>;

// ✅ Use readonly record struct for value objects
public readonly record struct BpmTempo(int Value)
{
    public int Value { get; } = Value is >= 40 and <= 240 
        ? Value 
        : throw new ArgumentOutOfRangeException(nameof(Value));
}

// ✅ Use sealed for classes that won't be inherited
public sealed class ProjectService : IProjectService

// ✅ Use primary constructors where appropriate
public sealed class ProjectService(IProjectRepository repository, ILogger<ProjectService> logger)

// ✅ Prefer async/await throughout
public async Task<Project> GetByIdAsync(ProjectId id, CancellationToken ct = default)

// ✅ Use CancellationToken on all async operations
await _client.GenerateAsync(request, ct);

// ❌ Don't use var when type isn't obvious
var thing = GetThing(); // What is thing?

// ✅ Be explicit
Project project = await GetProjectAsync(id);
```

### Python Conventions

#### Naming

| Element | Convention | Example |
|---------|-----------|---------|
| Classes | PascalCase | `TheoryEngine`, `AudioSynthesizer` |
| Functions | snake_case | `generate_audio`, `parse_intent` |
| Variables | snake_case | `sample_rate`, `midi_data` |
| Constants | SCREAMING_SNAKE_CASE | `MAX_DURATION`, `DEFAULT_TEMPO` |
| Private | _prefix | `_model`, `_process_chunk` |

#### Type Hints (Required)

```python
from typing import AsyncIterator
from dataclasses import dataclass

@dataclass
class TheoryOutput:
    chord_progression: list[str]
    sections: list[dict]
    midi_bytes: bytes

async def generate_audio(
    prompt: str, 
    duration: int, 
    genre: str
) -> AsyncIterator[tuple[bytes, float]]:
    """Generate audio chunks with progress."""
    ...
```

---

## Error Handling

### C#

```csharp
// Domain exceptions
public sealed class ProjectNotFoundException(ProjectId id) 
    : Exception($"Project {id} not found");

public sealed class GenerationFailedException(string reason) 
    : Exception($"Generation failed: {reason}");

// Use Result pattern for expected failures
public sealed record Result<T>(T? Value, string? Error, bool IsSuccess);
```

### Python

```python
class WorkerException(Exception):
    """Base exception for worker errors."""

class ModelNotLoadedException(WorkerException):
    """Model has not been loaded."""

class GenerationTimeoutException(WorkerException):
    """Generation exceeded timeout."""
```

---

## Testing Strategy

### C# Tests

- **Domain Tests**: Pure unit tests, no mocks needed
- **Application Tests**: Test handlers with mocked dependencies
- **Integration Tests**: Test full pipeline with in-memory database

```csharp
// Domain test example
public class ProjectTests
{
    [Fact]
    public void Create_WithValidSpec_ReturnsProject()
    {
        var spec = new SongSpecification("Test", Genre.Electronic, Mood.Chill, new BpmTempo(120));
        var project = Project.Create("Test", spec);
        
        project.Should().NotBeNull();
        project.Status.Should().Be(ProjectStatus.Draft);
    }
}
```

### Python Tests

```bash
# Run tests
pytest tests/ -v

# With coverage
pytest tests/ --cov=src --cov-report=html
```

---

## gRPC Protocol

### Proto Definition Location
`protos/worker.proto`

### Regenerating Code

```bash
# C# (automatic via .csproj)
dotnet build src/MusicForge.Infrastructure

# Python
python -m grpc_tools.protoc \
    -I protos \
    --python_out=workers/python/src/grpc_generated \
    --grpc_python_out=workers/python/src/grpc_generated \
    protos/worker.proto
```

---

## AI Agent Instructions

### Before Making Changes

1. **Read ARCHITECTURE.md** - Understand system design
2. **Read affected files** - Don't assume, verify
3. **Check for patterns** - Follow existing conventions
4. **Use SharpTools** - For C# operations (LoadSolution first)

### When Adding Features

1. Define domain entities/value objects first
2. Create application layer commands/queries
3. Implement infrastructure adapters
4. Add API endpoints last
5. Write tests alongside implementation

### When Fixing Bugs

1. Reproduce via existing tests if possible
2. Write failing test first
3. Fix with minimal changes
4. Verify all tests pass

### Common Mistakes to Avoid

- ❌ Don't add magic strings - use constants
- ❌ Don't catch generic Exception - be specific
- ❌ Don't return null - use Result or Option patterns
- ❌ Don't hardcode paths - use configuration
- ❌ Don't skip CancellationToken propagation

---

## Environment Variables

```bash
# .NET API
ASPNETCORE_ENVIRONMENT=Development
ConnectionStrings__Database=Data Source=musicforge.db
WorkerClient__Address=http://localhost:50051
LLM__Provider=ollama
LLM__OllamaUrl=http://localhost:11434
LLM__Model=llama3.2

# Python Worker
MUSICFORGE_GRPC_PORT=50051
MUSICFORGE_DEVICE=cuda  # or cpu
MUSICFORGE_MUSICGEN_MODEL_SIZE=medium  # small, medium, large
```

---

**Last Updated**: 2026-01-13
